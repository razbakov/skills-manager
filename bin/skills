#!/usr/bin/env bash
set -euo pipefail

SOURCE_PATH="${BASH_SOURCE[0]}"
while [ -L "${SOURCE_PATH}" ]; do
  SOURCE_DIR="$(cd -P -- "$(dirname -- "${SOURCE_PATH}")" && pwd)"
  LINK_TARGET="$(readlink "${SOURCE_PATH}")"
  if [[ "${LINK_TARGET}" == /* ]]; then
    SOURCE_PATH="${LINK_TARGET}"
  else
    SOURCE_PATH="${SOURCE_DIR}/${LINK_TARGET}"
  fi
done

SCRIPT_DIR="$(cd -P -- "$(dirname -- "${SOURCE_PATH}")" && pwd)"

resolve_bun() {
  if command -v bun >/dev/null 2>&1; then
    command -v bun
    return 0
  fi

  if [ -n "${BUN_INSTALL:-}" ] && [ -x "${BUN_INSTALL%/}/bin/bun" ]; then
    echo "${BUN_INSTALL%/}/bin/bun"
    return 0
  fi

  if [ -x "${HOME}/.bun/bin/bun" ]; then
    echo "${HOME}/.bun/bin/bun"
    return 0
  fi

  echo "Unable to find Bun. Install Bun and ensure it is available on PATH: https://bun.sh/" >&2
  exit 1
}

BUN_BIN="$(resolve_bun)"
exec "${BUN_BIN}" "${SCRIPT_DIR}/../src/index.ts" "$@"
