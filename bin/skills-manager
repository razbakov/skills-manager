#!/usr/bin/env bash
set -euo pipefail

SOURCE_PATH="${BASH_SOURCE[0]}"
while [ -L "${SOURCE_PATH}" ]; do
  SOURCE_DIR="$(cd -P -- "$(dirname -- "${SOURCE_PATH}")" && pwd)"
  LINK_TARGET="$(readlink "${SOURCE_PATH}")"
  if [[ "${LINK_TARGET}" == /* ]]; then
    SOURCE_PATH="${LINK_TARGET}"
  else
    SOURCE_PATH="${SOURCE_DIR}/${LINK_TARGET}"
  fi
done

SCRIPT_DIR="$(cd -P -- "$(dirname -- "${SOURCE_PATH}")" && pwd)"
INSTALL_SCRIPT="${SCRIPT_DIR}/../scripts/install.sh"

if [ "$#" -eq 0 ]; then
  echo "Usage: npx -y skills-manager <owner/repo|github-url> [skill ...]" >&2
  exit 1
fi

"${INSTALL_SCRIPT}"

if [ -n "${SKILLS_MANAGER_GLOBAL_BIN_DIR:-}" ]; then
  SKILLS_CMD_PATH="${SKILLS_MANAGER_GLOBAL_BIN_DIR%/}/skills"
elif [ -n "${BUN_INSTALL:-}" ]; then
  SKILLS_CMD_PATH="${BUN_INSTALL%/}/bin/skills"
else
  SKILLS_CMD_PATH="${HOME}/.bun/bin/skills"
fi

if [ -x "${SKILLS_CMD_PATH}" ]; then
  exec "${SKILLS_CMD_PATH}" set "$@"
fi

if command -v skills >/dev/null 2>&1; then
  exec "$(command -v skills)" set "$@"
fi

echo "Skills Manager was installed, but 'skills' command is unavailable." >&2
exit 1
